# SensumSDK - iOS v0.2

## iOS Device Compatibility

The iOS version of the **SensumSDK** can be installed on devices with **iOS 9.0 and up**.

We recommend the **iPhone 5 and up** as devices to use with the **SensumSDK**.

## Bluetooth Device Compatibility

* The iOS **SensumSDK** supports connecting to BLE devices for reading heart rate measurements. For a list of tested compatible devices please view the <a href = "http://help.sensum.co/knowledge_base/topics/what-type-of-sensors-can-i-use"> list of compatible devices</a> at our Knowledge Centre.

**Note:** This document is regularly updated with new devices. Please contact us for integration details.

## Accepted Biometric Data Inputs

The iOS **SensumSDK** can accept the following <a href = "#available-metrics">metrics</a>:

  * Heart Rate
  * GPS latitude
  * GPS longitude
  * GPS altitude
  * GPS accuracy
  * GPS speed
  * acceleration
  * acceleration X
  * acceleration Y
  * acceleration Z

## SDK Module Command Protocol

Each **SensumSDK** module conforms to the module command protocol.
At present these can be switched on and off independently. Each **SensumSDK**-managed object has two states that can be toggled independently:

* Updating: You will get live data updates from the respective managed object. If you have defined a listener for that object, its update methods will be called by the SDK and you can reflect these and carry out actions in your app.
* Sending To API: Data internally collected will be sent to the **SensumAPI**.

> Protocol Code - **SensumSDK** 

```swift
import foundation

public protocol SDKModuleCommandProtocol {
    func startUpdating()
    func stopUpdating()
    func startSendingToAPI()
    func stopSendingToAPI()
    func isUpdating() -> Bool
    func isSendingToAPI() -> Bool
}
```

## Starting the SensumSDK

To initialize the **SensumSDK** you will need:

 * An API Key,
 * A host URL,
 * A stage URL.

We will provide you with the API Key as a string. You will need to pass this string into the `SensumSDKManager`.

By default, the host URL and stage URL should be **"emotionai.sensum.co"** and **"v0"** respectively, unless we have instructed you otherwise.

The `SensumSDKManager` is the root object in the **SensumKit** which starts the service.
The manager prepares all objects you can use to interface with the native `CoreMotion`, `CoreLocation` and `CoreBluetooth` frameworks.

In order to create a single instance of the `SensumSDKManager`, follow the example within the Code Snippet below (the example makes use of a `TabBarController` to do this, but this could be achieved within any file, such as an `AppDelegate` or `ViewController`').

> Code Snippet

```swift
import UIKit
import SensumKit

class TabBarController: UITabBarController {
	var sensumSDK : SensumSDKManager?

	override func viewDidLoad() {
           super.viewDidLoad()
           // Do any additional setup after loading the view, typically from a nib.
           sensumSDK = SensumSDKManager(
               requestEngineInternalInSeconds: 30,
               apiKey: "PublicDemoKeyForDocumentation",
               host: "emotionai.sensum.co",
               stage: "v0")
	    startEverythingUpdating()
       }

	func startEverythingUpdating() {
		sensumSDK?.accelerometer.startUpdating()
		sensumSDK?.location.startUpdating()
		sensumSDK?.bluetooth.startUpdating()
		sensumSDK?.tag.startUpdating()
	}
}
```

This instance of the `SensumSDKManager` can then be referenced from elsewhere within your application.

## Authentication

To get started with the `SensumSDKManager` youâ€™re going to need a valid Authentication session. Create an instance of this object and give it valid sign-in details. When using third-party login providers you must provide us with an Audience ID. In the case of *Google Sign-In*, you must provide use with the *Google Applications Client ID*. You can find this id contained inside the plist configuration file generated when you set up the login application. For more details please read Google's documentation <a href="https://developers.google.com/identity/sign-in/ios/start-integrating"> here</a>.

## Authentication Command

### Federated sign-in

In order to authenticate you must sign in using *Google Sign-in*. Once this has been implemented, use this function to sign in to access the **SensumAPI**.

`sdkManager?.authentication.federatedSignIn(provider: provider, authenticationToken: authenticationToken)`  

### Parameters

|Name|Description|
|----|-----------|
|provider| The URL of the identity provider that you are using this will be 'accounts.google.com' in the case of *Google Sign-In*|
|authenticationToken|This is the authentication token generated by successful login with the identity provider|

## Assign a Listener

`sdkManager?.authentication.assignListener(listener)`

Assign a listener to listen for **SensumAPI** events.

### Parameters

|Name|Type|Description|
|----|-----------|----|
|listener|APIResponseListener|An instance of a class that conforms to the APIResponseListener extension|

### Check if User is Authenticated

Return the authentication status of the user. Authentication takes place on successfully login to a third party identity provider such as Google through Google SignIn.
     If the user is authenticated, they can access the API.
     Returns - a bool

`sdkManager?.authentication.isUserAuthenticated()`

## API Command

All available commands for configuring and enabling API communication.

### Set Server Request Rate

`apiCommand.setServerRequestRate(requestRateInSeconds)`

Set the frequency of data uploads to the **SensumAPI**.

### Parameters

|Name|Description|
|----|-----------|
|requestRateInSeconds|Frequency of requests made to the Sensum API in seconds|

### Get Server Request Rate

`apiCommand.getServerRequestRate()`

Returns how often requests are sent to the **SensumAPI**.

### Assign Listener

`apiCommand.assignListener(listener)`

Assign a listener to listen for **SensumAPI** events.

### Parameters

|Name|Type|Description|
|----|-----------|----|
|listener|APIResponseListener|An instance of a class that conforms to the APIResponseListener extension|

## Accelerometer Command

All available commands for the **SensumSDK** accelerometer component.

### Start Updating

`sdkManager?.accelerometer.startUpdating()`

Start requesting updates from the *CoreMotion* framework.

### Stop Updating

`sdkManager?.accelerometer.stopUpdating()`

Stop requesting updates from *CoreMotion* framework.

### Start Sending to API

`sdkManager?.accelerometer.startSendingToAPI()`

Start sending updates from *CoreMotion* to the **SensumAPI**.

### Stop Sending to API

`sdkManager?.accelerometer.stopSendingToAPI()`

Stop sending updates from *CoreMotion* to the **SensumAPI**.

### Check Module Update Status

`sdkManager?.accelerometer.isUpdating()`

Check if SensumKit is sending *CoreMotion* updates to the **SensumAPI**. Returns a boolean value.

### Check SensumAPI Update Status

`sdkManager?.accelerometer.isSendingToAPI()`

Check if *CoreMotion* Accelerometer is sending to the **SensumAPI**.

### Assign Listener

`sdkManager?.accelerometer.assignListener(listener)`

Assign a listener to the accelerometer module to receive *CoreMotion* event updates.


### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|listener|AccelerometerListener|An instance of a class that conforms to the AccelerometerListener extension|

### Set Read Frequency

`sdkManager?.accelerometer.setReadFrequency(newIntervalInSeconds)`

Set the frequency of the updates from the accelerometer.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|newIntervalInSeconds|Double|Set the interval time in seconds, (minimum interval is 0.01s)|

## Bluetooth Command

Below are all available commands relating to Bluetooth within the **SensumSDK**.

* **SensumKit** supports connecting to BLE devices for reading heart rate measurements. For a list of tested compatible devices please view the <a href = "http://help.sensum.co/knowledge_base/topics/what-type-of-sensors-can-i-use"> list of compatible devices</a> at our Knowledge Centre.

**Note:** This document is regularly updated with new devices. Please contact us for integration details. GSR data is only accessible from Shimmer devices at present.

### Start Updating

`sdkManager?.bluetooth.startUpdating()`

Start requesting updates from any connected heart rate peripheral.

### Stop Updating

 `sdkManager?.bluetooth.stopUpdating()`

Stop requesting updates of any connected heart rate peripheral.

### Start Sending to SensumAPI

`sdkManager?.bluetooth.startSendingToAPI()`

Start sending the updates of any connected heart rate peripheral to the **SensumAPI**.

### Stop Sending to SensumAPI

`sdkManager?.bluetooth.stopSendingToAPI()`

Stop sending the updates of any connected heart rate peripheral to the **SensumAPI**.

### Check Module Update Status

`sdkManager?.bluetooth.isUpdating()`

Check if module is updating. Returns a boolean value.

### Check SensumAPI Update Status

`sdkManager?.bluetooth.isSendingToAPI()`

Check if module is sending heart rate device updates to the **SensumAPI**.

### Assign Listener

`sdkManager?.bluetooth.assignListener(listener)`

Assign a listener to the bluetooth module to receive bluetooth event updates.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|listener|BluetoothListener|An instance of a class that conforms to the BluetoothListener extension|

### Start Scan for Devices

`sdkManager?.bluetooth.startScanForDevices()`

Start scanning for discoverable peripheral devices.

### Connect to peripheral device

`sdkManager?.bluetooth.connectTo(peripheralDevice)`

Connect to a discovered peripheral device. Discovered devices can be acquired from the listOfDevices returned by the `getDeviceList()` function.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|peripheralDevice|CBPeripheral|The bluetooth peripheral device you want to connect to|

### Clear List of Discovered Devices

`sdkManager?.bluetooth.clearDeviceList()`

Clear the list of devices discovered (equivalent to a refresh).

### Disconnect from Device

`sdkManager?.bluetooth.disconnect()`

Disconnect from the currently connected peripheral device.

### Get Device List

`sdkManager?.bluetooth.getDeviceList()`

Return a list of all discovered peripherals. The list will begin populating after `startScanForDevices()` is called.

Returns a list of dictionaries containing bluetooth peripheral information with three fields:

|Field Name|Type|Description|
|----------|----|-----------|
|deviceName|String|returns a String of the device name|
|peripheral|CoreBluetooth CBPeripheral| returns the CoreBluetooth `CBPeripheral` object (import CoreBluetooth to use this)|
|type|String|For now all peripherals are of type BLE|

> Example Usage

````swift
     if let peripheralDictionary = sdkManager?.bluetooth.getDeviceList()[index]?["peripheral"] {
        let peripheralToAdd = peripheralDictionary as! CBPeripheral
     }
````

## Location Command

All available commands for the **SensumSDK** location component.

### Start Updating

`sdkManager?.location.startUpdating()`

Start the updates from *CoreLocation*.

### Stop Updating

`sdkManager?.location.stopUpdating()`

Stop the updates from *CoreLocation*.

### Start Sending to API

`sdkManager?.location.startSendingToAPI()`

Start sending the updates of *CoreLocation* to the **SensumAPI**.

### Stop Sending to API

`sdkManager?.location.stopSendingToAPI()`

Stop sending the updates of *CoreLocation* to the **SensumAPI**.

### Check Module Update Status

`sdkManager?.location.isUpdating()`

Check if the location module is updating. Returns a boolean value.

### Check SensumAPI Update Status

`sdkManager?.location.isSendingToAPI()`

Check if SensumKit is sending updates from the *CoreLocation* framework to the **SensumAPI**.

### Assign Listener

`sdkManager?.location.assignListener()`

Assign a listener to the location module to receive *CoreLocation* event updates.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|listener|LocationListener|An instance of a class that conforms to the LocationListener extension|

## Unicode Tag Command

All available commands for our tagging module. This is useful for noting events that occur in data. e.g. "Started workout set", "Jumped out of a plane", "Finished jogging".
These events are automatically timestamped.

### Start Updating

`sdkManager?.unicodeTag.startUpdating()`

Start receiving updates from the unicodeTag system which notifies listeners of new tags.

### Stop Updating

`sdkManager?.unicodeTag.stopUpdating()`

Stop receiving updates from the unicodeTag system.

### Start Sending to SensumAPI

`sdkManager?.unicodeTag.startSendingToAPI()`

Start sending new unicodeTags to the **Sensum API**.

### Stop Sending to SensumAPI

`sdkManager?.unicodeTag.stopSendingToAPI()`

Stop sending new unicodeTags to the **Sensum API**.

### Check Module Update Status

`sdkManager?.unicodeTag.isUpdating()`

Check if the unicodeTag module is updating. Returns a boolean value.

### Check SensumAPI Update Status

`sdkManager?.unicodeTag.isSendingToAPI()`

Check if the unicodeTag module is sending to the **SensumAPI**.

### Assign Listener

`sdkManager?.unicodeTag.assignListener(listener)`

Assign a listener to the unicodeTag module to receive tag event updates.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|listener|UnicodeTagListener|An instance of a class that conforms to the TagListener extension|

### Create Tag

`sdkManager?.unicodeTag.createTag(tag)`

Creates a unicodeTag object composed of a string and timestamp.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|tag|String|A string object of a message or emoticon|

## Sentiment Command

All available commands for our sentiment module. This runs analysis on the text input and returns it's emotionality data. 

### Start Updating

`sdkManager?.sentiment.startUpdating()`

Start the updates from the sentiment text system which notifies listeners of new sentiment text .

### Stop Updating

`sdkManager?.sentiment.stopUpdating()`

 Stop the updates from the sentiment system.

### Start Sending to SensumAPI

`sdkManager?.sentiment.startSendingToAPI()`

 Start sending sentiment text to the **SensumAPI**.

### Stop Sending to SensumAPI

`sdkManager?.sentiment.stopSendingToAPI()`

 Stop sending sentiment text to the **SensumAPI**.

### Check Module Update Status

`sdkManager?.sentiment.isUpdating()`

Check if the sentiment text module is updating. Returns a boolean value.


### Check SensumAPI Update Status

`sdkManager?.sentiment.isSendingToAPI()`

Check if the sentiment text module is sending to the **SensumAPI**.

### Assign Listener

`sdkManager?.sentiment.assignListener(listener)`

Assign a listener to the sentiment text module to receive sentiment updates.


### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|listener|SentimentListener|An instance of a class that conforms to the SentimentListener extension|

### Create Sentiment

`sdkManager?.sentiment.createSentiment(sentiment)`

Creates a sentiment object composed of a string and timestamp pair.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|sentiment|String|A string object of a message or emoticon|

## APIListener

To be able to listen for updates from the API you must extend your class using an extension of type `API Listener` using the following example code.

> APIListener extension

```swift
 extension ViewController: APIListener {
    func apiRequestSuccessful() {
      // update a label or log success
    }
	  func apiRequestFailure(message: String, statusCode: Int?) {
      // inform the user or log failed attempt
    }
	  func retrieveJSONFromSensumAPI(json: [String:Any]?) {
      // parse serialised json here, pass to view labels or persist to database
    }
	  func sentimentRequestSuccesful() {
      // update a label or log success
    }
	  func sentimentRequestFailure(message: String, statusCode: Int?) {
      // inform the user or log failed attempt
    }
}
```

### API Listener Functions: API Request Successful

`func apiRequestSuccessful()`

Used to notify listeners that a request made to the **SensumAPI** was successful.
Updated immediately after a 200 HTTP response is received.

### API Listener Functions: API Request Failure

`func apiRequestFailure(message: String, statusCode: Int?)`

  Used to notify listeners that a request made to the **SensumAPI** was unsuccessful..

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|message|String|The error message from the HTTP request|
|statusCode|Int?|Optional URLResponse HTTP status code from the HTTP request|

### API Listener Functions: Retrieve JSON From **SensumAPI**

`func retrieveJSONFromSensumAPI(json: [String:Any]?)`

	Used to notify listeners that a successful request body has been serialised into JSON and is available for use in the users application.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|json|JSON|A dictionary of JSON returned from the **SensumAPI**|
  
### API Listener Functions: Sentiment Request Successful

  `func sentimentRequestSuccesful()`

Used to notify listeners that a request made to the **SensumAPI** sentiment endpoint was successful. Note this is only for sentiment analysis and not general requests.
	Called immediately after a 200 HTTP response is received.
 
### API Listener Functions: Sentiment Request Failure

  `func sentimentRequestFailure(message: String, statusCode: Int?)`
  
Used to notify listeners that a request made to the **SensumAPI** sentiment endpoint was unsuccessful. Note this is only for sentiment analysis and not general requests.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|message|String|The error message from the HTTP request|
|statusCode|Int|Optional URLResponse HTTP status code from the HTTP request|

## AccelerometerListener

Accelerometer listeners handle updates from the **SensumSDK** accelerometer component.
Subscribers will be notified of updates to the Accelerometer object. To use this listener extend your class using the following example code:

> AccelerometerListener extension

```swift
extension AccelerometerViewController: AccelerometerListener {
  func accelerationUpdated(newAcceleration: CMAcceleration, dateTime: Date) {
      // update a label or persist to a database  
    }
}
```

### AccelerometerListener Functions: Acceleration Updated

`func accelerationUpdated(newAcceleration: CMAcceleration, dateTime: Date)`

Called when a new accelerometer value is generated by the CoreMotion framework.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|newAcceleration|CMAcceleration|A raw acceleration object from the CoreMotion framework.|
|dateTime|Date|The native Date() of when the acceleration object was received by the SDK.|


## AuthenticationListener

This listener can be used to handle the Authentication component of the local federated identity sign-in process. This step occurs after the third party login, where the **SensumAPI** will validate the idToken from the end user.

### AuthenticationListener Functions: Sign In Successful

  `func signInSuccesful(message: String)`

Implement to handle the result of a successful login to the **SensumAPI** after the third party identity provider authentication.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|message|String| A success message from a valid sign-in result.|

### AuthenticationListener Functions: Sign In Failed

  `func signInFailed(message: String)`

### AuthenticationListener Functions: Sign In Successful

  `func signInSuccesful(message: String)`

Implement to handle the result of a successful login to the **SensumAPI** after the third party identity provider authentication.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|message|String| A fail message from an invalid sign-in result.|


## BluetoothListener

Bluetooth listeners handle updates from the **SensumSDK** bluetooth component.
Subscribers will be notified of updates to the Bluetooth object.

To use a BluetoothListener extend your class as in the following example code:

>BluetoothListener extension

```swift
extension BluetoothTableViewController: BluetoothListener {
  public func deviceDiscovered() {
    // reload tableView to show more devices coming in
  }
  public func heartrateUpdated(beatsPerMinute: Int, dateTime: Date) {
    // save bpm to database or update a view
  }
  public func deviceConnectionSuccess(peripheral: CBPeripheral) {
    // show the user a confirmation connection
  }
  public func deviceConnectionFailure(peripheral: CBPeripheral) {
    // inform the user the connection process failed
  }
  public func deviceDisconnected(peripheral: CBPeripheral) {}
    // show the user their device disconnected, prompt a reconnection
}
```

### BluetoothListener Functions: Device Discovered

  `func deviceDiscovered()`  

  Called when a BLE device has been discovered during a device scan.

### BluetoothListener Functions: Device Connection Success

  `func deviceConnectionSuccess(peripheral: CBPeripheral)`  

  Called when the users device has successfully connected to a BLE device.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|peripheral|CBPeripheral|The CoreBluetooth device peripheral connected to.|

### BluetoothListener Functions: Device Connection Failure

  `func deviceConnectionFailure(peripheral: CBPeripheral)`  

  Called when the users device has failed to connect to a BLE device.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|peripheral|CBPeripheral|The CoreBluetooth device peripheral that failed to connect.|

### BluetoothListener Functions: Device Disconnected

  `func deviceDisconnected(peripheral: CBPeripheral)`  

  Called when the users device has been disconnected from a BLE device.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|peripheral|CBPeripheral|The CoreBluetooth device peripheral that disconnected.|

### BluetoothListener Functions: BPM Updated

  `func heartrateUpdated(beatsPerMinute: Int, dateTime: Date)`

  Called when the BLE device connected to the users device has a processed update value ready.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|beatsPerMinute|Int|A heart rate value represented beats per minute.|
|dateTime|Date|A native `Date()` object of when the reading was generated.|  

## LocationListener

Location listeners handles updates from the Location **SensumSDK** component.
Subscribers will be notified of updates to the Location object.

To use a LocationListener, extend your class as seen in the following example code:

> LocationListener extension

```swift
extension GPSViewController: LocationListener {
    func locationUpdated(newLocation: CLLocation) {
        // update a label or persist locally to a datbase
    }
}
```

### LocationListener Functions: Location Updated

  `func locationUpdated(newLocation:CLLocation)`

  Called when a new location update has been generated by the device.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|newLocation|CLLocation|A CoreLocation type location object containing fine values about the device location.|

## UnicodeTagListener

This listener can be used to handle the response to Tag objects of unicode text/emoji objects.

### UnicodeTagListener Functions: Tag Created

 `func tagCreated(newTag: String, dateTime: Date)`

 Called when a new unicodeTag object is created.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|newTag|String|The literal string tag that was created.|
|dateTime|Date|A native `Date()` object representing time and date when the tag was created.|

## SentimentListener

This listener can be used to handle the event of a newly created Sentiment object of unicode text/emoji objects from local user input.
This is NOT used for retrieving Sentiment from the **SensumSDK**. Please use the *APIListener.swift* protocols instead.

### SentimentListener Functions: Sentiment Created

`func func sentimentCreated(sentimentText: String, dateTime: Date)`

Used to nofity listeners that a new sentiment object was created locally.

### Parameters

|Parameter|Type|Description|
|---------|----|-----------|
|sentimentText|String|The literal string sentiment that was created.|
|dateTime|Date|A native `Date()` object representing time and date when the sentiment was created.|

## ServerRequestEngine

### ServerRequestEngine Functions: Set Request Interval

`public func setRequestInterval(newUpdateInterval : Int)`

This changes the interval immediately, destroying the old timer and starting a new one counting from time zero.

### Parameters

Parameter|Type|Description|
|--------|----|-----------|
|newUpdateInterval|Int|The new update interval in seconds|